<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retoucher Pro</title>
    <style>
        :root { --bg: #0a0a0a; --glass: rgba(30, 30, 30, 0.85); --accent: #007aff; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #viewer { position: relative; width: 100vw; height: 100vh; overflow: hidden; touch-action: none; display: flex; align-items: center; justify-content: center; }
        canvas { position: absolute; image-rendering: pixelated; }
        
        /* iPhone Style Dock */
        .dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; background: var(--glass); backdrop-filter: blur(15px); border-radius: 24px; border: 0.5px solid rgba(255,255,255,0.1); z-index: 1000; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .box { width: 55px; height: 55px; border-radius: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 9px; font-weight: bold; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.05); text-transform: uppercase; }
        .box:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .box.active { border: 2px solid var(--accent); box-shadow: 0 0 10px var(--accent); }
        #brush-preview { width: 24px; height: 24px; border-radius: 6px; margin-bottom: 4px; border: 1px solid white; }

        /* Panels */
        .panel { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--glass); backdrop-filter: blur(20px); border-radius: 20px; padding: 15px; display: none; flex-direction: column; gap: 15px; width: 280px; border: 0.5px solid rgba(255,255,255,0.1); z-index: 999; }
        .panel.open { display: flex; }
        
        /* Brush Box Elements */
        .slider-group { display: flex; flex-direction: column; gap: 5px; }
        .slider-label { color: #aaa; font-size: 10px; letter-spacing: 1px; }
        input[type=range] { width: 100%; height: 6px; border-radius: 3px; accent-color: var(--accent); }
        #rainbow-slider { -webkit-appearance: none; height: 6px; border-radius: 3px; background: linear-gradient(to right, #000, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #fff); }
        #rainbow-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: white; border-radius: 50%; border: 2px solid black; }
        
        .matrix { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .shade { aspect-ratio: 1/1; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); }
        .shade.selected { border: 2px solid white; box-shadow: 0 0 8px white; }

        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; color: white; text-align: center; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div id="viewer">
    <canvas id="btx"></canvas> <canvas id="etx"></canvas> <canvas id="utx"></canvas> </div>

<div class="panel" id="menu-panel">
    <div class="tool-grid">
        <div class="btn" onclick="imp()">IMPORT</div>
        <div class="btn" onclick="exp()">EXPORT</div>
        <div class="btn" onclick="vault()">VAULT</div>
        <div class="btn" onclick="burn()">BURN</div>
        <div class="btn" onclick="location.reload()">RELOAD</div>
    </div>
</div>

<div class="panel" id="tools-panel">
    <div class="tool-grid">
        <div class="btn" id="btn-bridge" onclick="setTool('bridge')">BRIDGE</div>
        <div class="btn" id="btn-smooth" onclick="setTool('smooth')">SMOOTH</div>
        <div class="btn" id="btn-sticker" onclick="sticker()">STICKER</div>
        <div class="btn" id="btn-cut" onclick="setTool('cut')">CUT</div>
        <div class="btn" id="btn-copy" onclick="setTool('copy')">COPY</div>
        <div class="btn" id="btn-paste" onclick="paste()">PASTE</div>
        <div class="btn" onclick="undo()">UNDO</div>
    </div>
</div>

<div class="panel" id="brush-panel">
    <div class="matrix" id="shade-matrix"></div>
    <div class="slider-group">
        <span class="slider-label">COLOR</span>
        <input type="range" id="rainbow-slider" min="0" max="360" value="0" oninput="updateMatrix()">
    </div>
    <div class="slider-group">
        <span class="slider-label">SIZE</span>
        <input type="range" id="size-slider" min="1" max="100" value="10">
    </div>
    <div class="slider-group">
        <span class="slider-label">TRANSPARENCY</span>
        <input type="range" id="alpha-slider" min="1" max="100" value="100">
    </div>
</div>

<div class="dock">
    <div class="box" onclick="toggleP('menu-panel')">MENU</div>
    <div class="box" onclick="toggleP('tools-panel')">TOOLS</div>
    <div class="box" onclick="qsave()" style="background: rgba(0,122,255,0.2);">QSAVE</div>
    <div class="box" onclick="toggleP('brush-panel')">
        <div id="brush-preview"></div>
        BRUSH
    </div>
    <div class="box" id="edit-status" onclick="toggleEdit()">PAN</div>
</div>

<script>
    const b = document.getElementById('btx'), bctx = b.getContext('2d');
    const e = document.getElementById('etx'), ectx = e.getContext('2d');
    const u = document.getElementById('utx'), uctx = u.getContext('2d');
    const view = document.getElementById('viewer');
    
    let state = { tool: 'brush', color: '#ff0000', size: 10, alpha: 1, edit: false, 
                  zoom: 1, x: 0, y: 0, undoStack: [], redoStack: [], clip: null };
    let startX, startY, isDrawing = false;

    // Canvas Setup
    function init() {
        b.width = e.width = u.width = window.innerWidth * 2;
        b.height = e.height = u.height = window.innerHeight * 2;
        b.style.width = e.style.width = u.style.width = '100vw';
        b.style.height = e.style.height = u.style.height = '100vh';
        updateMatrix();
    }

    // Mathematical Undo logic (Saves paths, not pixels)
    function saveStroke(type, path, settings) {
        state.undoStack.push({ type, path, settings });
        if(state.undoStack.length > 10) state.undoStack.shift();
    }

    function undo() {
        if(state.undoStack.length === 0) return;
        state.undoStack.pop();
        redraw();
    }

    function redraw() {
        ectx.clearRect(0, 0, e.width, e.height);
        state.undoStack.forEach(s => {
            ectx.beginPath();
            ectx.strokeStyle = s.settings.color;
            ectx.lineWidth = s.settings.size;
            ectx.globalAlpha = s.settings.alpha;
            ectx.lineCap = 'round';
            ectx.moveTo(s.path[0].x, s.path[0].y);
            s.path.forEach(p => ectx.lineTo(p.x, p.y));
            ectx.stroke();
        });
    }

    // Toggle Panels
    function toggleP(id) {
        document.querySelectorAll('.panel').forEach(p => { if(p.id !== id) p.classList.remove('open'); });
        document.getElementById(id).classList.toggle('open');
    }

    function toggleEdit() {
        state.edit = !state.edit;
        document.getElementById('edit-status').innerText = state.edit ? 'DRAW' : 'PAN';
    }

    function setTool(t) {
        state.tool = t;
        state.edit = true;
        document.getElementById('edit-status').innerText = 'DRAW';
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+t)?.classList.add('active');
    }

    // Color Engine
    function updateMatrix() {
        const hue = document.getElementById('rainbow-slider').value;
        const matrix = document.getElementById('shade-matrix');
        matrix.innerHTML = '';
        for(let i=0; i<10; i++) {
            const l = i < 5 ? 30 + (i*10) : 10 + (i*10);
            const s = i < 5 ? 100 : 50;
            const c = `hsl(${hue}, ${s}%, ${l}%)`;
            const d = document.createElement('div');
            d.className = 'shade';
            d.style.background = c;
            d.onclick = () => {
                state.color = c;
                document.getElementById('brush-preview').style.background = c;
                document.querySelectorAll('.shade').forEach(s => s.classList.remove('selected'));
                d.classList.add('selected');
            };
            matrix.appendChild(d);
        }
    }

    // Touch Handling
    view.addEventListener('touchstart', (e) => {
        const t = e.touches[0];
        startX = (t.clientX - state.x) / state.zoom;
        startY = (t.clientY - state.y) / state.zoom;
        if(state.edit) {
            isDrawing = true;
            currentPath = [{x: startX * 2, y: startY * 2}];
        }
    });

    let currentPath = [];
    view.addEventListener('touchmove', (ev) => {
        if(!state.edit) return; 
        const t = ev.touches[0];
        const nx = (t.clientX - state.x) / state.zoom * 2;
        const ny = (t.clientY - state.y) / state.zoom * 2;
        
        if(isDrawing) {
            ectx.lineCap = 'round';
            ectx.strokeStyle = state.color;
            ectx.lineWidth = document.getElementById('size-slider').value;
            ectx.globalAlpha = document.getElementById('alpha-slider').value / 100;
            
            ectx.beginPath();
            ectx.moveTo(currentPath[currentPath.length-1].x, currentPath[currentPath.length-1].y);
            ectx.lineTo(nx, ny);
            ectx.stroke();
            currentPath.push({x: nx, y: ny});
            
            if(state.tool === 'cut' || state.tool === 'copy') {
                uctx.clearRect(0,0,u.width,u.height);
                uctx.strokeStyle = '#00faff';
                uctx.setLineDash([5, 5]);
                uctx.strokeRect(startX*2, startY*2, nx - startX*2, ny - startY*2);
            }
        }
    });

    view.addEventListener('touchend', () => {
        if(isDrawing) {
            saveStroke(state.tool, currentPath, {color: state.color, size: state.size, alpha: state.alpha});
            isDrawing = false;
            uctx.clearRect(0,0,u.width,u.height);
        }
    });

    // Image Functions
    function qsave() {
        bctx.drawImage(e, 0, 0);
        ectx.clearRect(0, 0, e.width, e.height);
        state.undoStack = [];
        alert("Baking Complete. Undo History Reset.");
    }

    function sticker() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = ev => {
            const reader = new FileReader();
            reader.onload = a => {
                const img = new Image();
                img.onload = () => {
                    const sw = b.width * 0.8;
                    const sh = img.height * (sw / img.width);
                    ectx.drawImage(img, (b.width-sw)/2, (b.height-sh)/2, sw, sh);
                };
                img.src = a.target.result;
            };
            reader.readAsDataURL(ev.target.files[0]);
        };
        input.click();
    }

    function burn() { if(confirm("Burn Canvas?")) bctx.clearRect(0,0,b.width,b.height); ectx.clearRect(0,0,e.width,e.height); }

    init();
</script>
</body>
</html>


                            
