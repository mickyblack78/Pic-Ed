<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Retoucher Pro Fluoro - Full Build</title>
<style>
:root {
    --bg: #000000;
    --glass: rgba(15, 15, 15, 0.98);
    --fluoro: #00ff66;
    --glow: 0 0 20px #00ff66;
    --ui-font: 'Inter', sans-serif;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; padding: 0; overflow: auto;
    background-color: var(--bg); font-family: var(--ui-font);
    width: 100vw; height: 100vh;
}

#viewer { width: 100vw; height: 100vh; position: relative; background-color: #0a0a0a; z-index: 1; overflow: hidden; }
canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; }
#mainLayer { z-index: 2; }
#drawLayer { z-index: 3; pointer-events: none; }

.dock {
    position: fixed; bottom: 20px; left: 50%; margin-left: -160px;
    display: flex; flex-direction: row; gap: 8px; padding: 10px;
    background-color: var(--glass); border-radius: 28px;
    border: 1px solid rgba(0,255,102,0.3); z-index: 10000;
    width: 320px; justify-content: center; transform-origin: bottom center;
}

.box {
    width: 60px; height: 60px; border-radius: 18px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: #fff; font-size: 9px; font-weight: 900; cursor: pointer;
    background-color: rgba(255,255,255,0.05);
    border: 1.5px solid transparent; transition: all 0.2s ease;
}

.box.active {
    border-color: var(--fluoro);
    box-shadow: var(--glow);
    color: var(--fluoro);
}

.panel {
    position: fixed; bottom: 110px; left: 50%; margin-left: -160px;
    background-color: var(--glass); border-radius: 24px; padding: 15px;
    display: none; width: 320px; border: 1px solid var(--fluoro);
    z-index: 9999; transform-origin: bottom center;
}

.panel.open { display: flex; flex-direction: column; gap: 12px; }

.grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; }
.btn {
    padding: 12px; background-color: rgba(255,255,255,0.1); border-radius: 12px;
    color: #fff; text-align: center; font-size: 10px; font-weight: bold;
    border: 1px solid transparent; cursor: pointer;
}
.btn.active {
    border-color: var(--fluoro);
    color: var(--fluoro);
    box-shadow: var(--glow);
}

.thumb {
    width: 45px; height: 45px; border: 1.5px solid var(--fluoro);
    background-color: #000; object-fit: contain;
}

.shade-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 5px; margin-bottom: 10px; }
.shade-box {
    height: 32px; border-radius: 6px; border: 1px solid #333;
}
  </head>
<body>

<div id="viewer">
    <canvas id="mainLayer"></canvas>
    <canvas id="drawLayer"></canvas>
</div>

<div class="panel" id="menu-panel">
    <div class="grid-3">
        <div class="btn" onclick="imp()">IMPORT</div>
        <div class="btn" id="dl-pick-btn" onclick="toggleDLMode()">DL PICK</div>
        <div class="btn" onclick="vAction('save', 0)">VAULT S1</div>
        <div class="btn" onclick="vAction('save', 1)">VAULT S2</div>
    </div>
    <div style="display:flex; justify-content:center; gap:15px; margin-top:10px;">
        <div onclick="vaultClick(0)"><img id="v-thumb-0" class="thumb"><br><center style="color:white;font-size:8px">VAULT 1</center></div>
        <div onclick="vaultClick(1)"><img id="v-thumb-1" class="thumb"><br><center style="color:white;font-size:8px">VAULT 2</center></div>
        <div onclick="vaultClick('q')"><img id="q-thumb-menu" class="thumb"><br><center style="color:white;font-size:8px">QSAVE</center></div>
    </div>
</div>

<div class="panel" id="tools-panel">
    <div class="grid-3">
        <div class="btn t-btn" id="smooth" onclick="toggleT('smooth')">SMOOTH</div>
        <div class="btn t-btn" id="bridge" onclick="toggleT('bridge')">BRIDGE</div>
        <div class="btn t-btn" id="text" onclick="toggleT('text')">TEXT</div>
        <div class="btn t-btn" id="picker" onclick="toggleT('picker')">PICKER</div>
        <div class="btn" onclick="toggleP('select-panel')">STYLE</div>
        <div class="btn" onclick="handleSticker()">STICKER</div>
        <div class="btn" id="paste-btn" onclick="handlePaste()">PASTE</div>
        <div class="btn t-btn" id="cut" onclick="toggleT('cut')">CUT</div>
        <div class="btn t-btn" id="copy" onclick="toggleT('copy')">COPY</div>
        <div class="btn" onclick="undo()" style="grid-column: span 3;">UNDO LAST ACTION</div>
    </div>
</div>

<div class="panel" id="brush-panel">
    <div class="shade-grid" id="shade-grid"></div>
    <div style="display:flex; align-items:center; gap:15px;">
        <div id="brush-preview"></div>
        <div style="flex-grow:1;">
            <input type="range" id="hue-s" min="0" max="360" value="150" oninput="upClr()">
            <input type="range" id="size-s" min="1" max="100" value="20" oninput="upClr()">
        </div>
    </div>
</div>

<div class="panel" id="select-panel">
    <div class="style-grid" id="style-grid"></div>
</div>

<div class="dock">
    <div class="box" id="menu-box" onclick="toggleP('menu-panel')">MENU</div>
    <div class="box" id="tools-box" onclick="toggleP('tools-panel')">TOOLS</div>
    <div class="box" id="q-box" onclick="qSave()">
        <img id="q-thumb-dock" class="thumb" style="width:30px;height:30px;border:none;">
        <span style="margin-top:2px;">QSAVE</span>
    </div>
    <div class="box" id="brush-box" onclick="toggleP('brush-panel')">BRUSH</div>
    <div class="box" id="edit-box" onclick="toggleEdit()">EDIT</div>
</div>

#brush-preview { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; }
#hue-s { width: 100%; height: 18px; border-radius: 10px; -webkit-appearance: none; 
         background: linear-gradient(to right,#fff,#ff0000,#ffff00,#00ff00,#00ffff,#0000ff,#ff00ff,#000); }

.style-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; max-height: 200px; overflow-y: auto; }
.style-item { height: 60px; background-color: #222; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; color: #fff; border: 1px solid #444; }
.style-item.active { border-color: var(--fluoro); color: var(--fluoro); }
</style>
<script>
/**
 * SURGICAL REPAIR - FULL JS ENGINE
 */
const m = document.getElementById('mainLayer');
const mctx = m.getContext('2d');
const d = document.getElementById('drawLayer');
const dctx = d.getContext('2d');

// Physics placeholders
let vx = 0, vy = 0, friction = 0.95, spring = 0.1, velocityX = 0, velocityY = 0, gravity = 0, ticking = false;

let cfg = {
    color: '#00ff66',
    size: 20,
    tool: null,
    edit: false,
    history: [],
    clip: null,
    path: [],
    font: 'sans-serif',
    dlMode: false,
    pasting: false,
    px: 0, py: 0,
    anchorX: 0, anchorY: 0
};

let isDrawing = false;
let lx = 0, ly = 0, bStartX = 0, bStartY = 0, db = null;

// IndexedDB for vault persistence
const request = indexedDB.open("WaterfallPro_DB_Surgery", 1);
request.onupgradeneeded = function(event) {
    let database = event.target.result;
    if (!database.objectStoreNames.contains("slots")) {
        database.createObjectStore("slots");
    }
};
request.onsuccess = function(event) {
    db = event.target.result;
    loadVaultThumbs();
};

// INIT FONT GRID
function init() {
    m.width = window.innerWidth * 2;
    m.height = window.innerHeight * 2;
    d.width = window.innerWidth * 2;
    d.height = window.innerHeight * 2;

    mctx.lineCap = 'round';
    mctx.lineJoin = 'round';
    dctx.lineCap = 'round';
    dctx.lineJoin = 'round';

    const sg = document.getElementById('style-grid');
    const fonts = ['sans-serif','serif','monospace','cursive','fantasy','system-ui','italic','bold','small-caps','900','oblique','Georgia'];
    fonts.forEach(function(f){
        let s = document.createElement('div');
        s.className = 'style-item';
        s.style.fontFamily = f;
        s.innerHTML = '<span style="font-size:16px">Aa</span><br><span style="font-size:8px">'+f+'</span>';
        s.onclick = function(){
            cfg.font = f;
            document.querySelectorAll('.style-item').forEach(i=>i.classList.remove('active'));
            s.classList.add('active');
        };
        sg.appendChild(s);
    });

    upClr();

    if(window.visualViewport){
        window.visualViewport.addEventListener('scroll', updateUI);
        window.visualViewport.addEventListener('resize', updateUI);
    }
}

// VIEWPORT SURGERY - ANTI-JITTER
function updateUI(){
    if(!ticking){
        window.requestAnimationFrame(function(){
            const v = window.visualViewport;
            const scale = 1/v.scale;
            const tx = v.pageLeft + (v.width/2) - (window.innerWidth/2);
            const ty = v.pageTop + (v.height/2) - (window.innerHeight/2);

            const dock = document.querySelector('.dock');
            const panels = document.querySelectorAll('.panel');

            dock.style.transform = 'translate('+tx+'px,'+ty+'px) scale('+scale+')';
            panels.forEach(p=>p.style.transform='translate('+tx+'px,'+ty+'px) scale('+scale+')');
            ticking=false;
        });
        ticking=true;
    }
}

// COLOR ENGINE
function upClr(){
    const h = document.getElementById('hue-s').value;
    let base;
    if(h<10) base='#ffffff';
    else if(h>350) base='#000000';
    else base='hsla('+h+',100%,50%,1)';

    cfg.color=base;
    cfg.size=document.getElementById('size-s').value;
    document.getElementById('brush-preview').style.backgroundColor=base;
    document.getElementById('brush-box').style.backgroundColor=base;

    const grid=document.getElementById('shade-grid');
    grid.innerHTML='';
    for(let i=0;i<10;i++){
        let s=document.createElement('div');
        s.className='shade-box';
        let lum=5+(i*10);
        let c='hsla('+h+',100%,'+lum+'%,1)';
        s.style.backgroundColor=c;
        s.onclick=function(){ cfg.color=c; document.getElementById('brush-box').style.backgroundColor=c; };
        grid.appendChild(s);
    }
}

function toggleP(id){
    const p=document.getElementById(id);
    const isOpen=p.classList.contains('open');
    document.querySelectorAll('.panel').forEach(el=>el.classList.remove('open'));
    if(!isOpen) p.classList.add('open');
}

function toggleT(t){
    cfg.tool=(cfg.tool===t)?null:t;
    document.querySelectorAll('.t-btn').forEach(b=>b.classList.toggle('active',b.id===cfg.tool));
}

function toggleEdit(){
    cfg.edit=!cfg.edit;
    document.getElementById('edit-box').classList.toggle('active',cfg.edit);
}
  /**
 * TOUCH & DRAW HANDLERS
 */
window.addEventListener('touchstart', function(e){
    if(e.target.closest('.dock') || e.target.closest('.panel')) return;
    if(!cfg.tool && !cfg.edit) return;

    e.preventDefault();
    const rect=d.getBoundingClientRect();
    const tx=(e.touches[0].clientX-rect.left)*(d.width/rect.width);
    const ty=(e.touches[0].clientY-rect.top)*(d.height/rect.height);

    if(cfg.tool==='picker'){
        const data=mctx.getImageData(tx,ty,1,1).data;
        cfg.color='rgba('+data[0]+','+data[1]+','+data[2]+','+(data[3]/255)+')';
        document.getElementById('brush-box').style.backgroundColor=cfg.color;
        return;
    }

    isDrawing=true;
    lx=tx; ly=ty;
    cfg.path=[{x:tx,y:ty}];

    if(cfg.tool==='bridge'){ bStartX=tx; bStartY=ty; }

    if(cfg.pasting){
        cfg.anchorX=tx-cfg.px;
        cfg.anchorY=ty-cfg.py;
    }
},{passive:false});

window.addEventListener('touchmove', function(e){
    if(!isDrawing && !cfg.pasting) return;
    e.preventDefault();
    const rect=d.getBoundingClientRect();
    const nx=(e.touches[0].clientX-rect.left)*(d.width/rect.width);
    const ny=(e.touches[0].clientY-rect.top)*(d.height/rect.height);

    if(cfg.pasting){
        dctx.clearRect(0,0,d.width,d.height);
        const temp=document.createElement('canvas');
        temp.width=d.width; temp.height=d.height;
        const tctx=temp.getContext('2d');

        cfg.px=nx-cfg.anchorX;
        cfg.py=ny-cfg.anchorY;

        tctx.putImageData(cfg.clip,cfg.px-(cfg.clip.width/2),cfg.py-(cfg.clip.height/2));
        dctx.globalAlpha=0.5;
        dctx.drawImage(temp,0,0);
        dctx.globalAlpha=1.0;
        return;
    }

    if(cfg.tool==='cut'||cfg.tool==='copy'){
        dctx.strokeStyle='#00ff66';
        dctx.lineWidth=2;
        dctx.setLineDash([5,5]);
        dctx.beginPath();
        dctx.moveTo(lx,ly);
        dctx.lineTo(nx,ny);
        dctx.stroke();
        cfg.path.push({x:nx,y:ny});
    }
    else if(cfg.tool==='bridge'){
        dctx.clearRect(0,0,d.width,d.height);
        if(cfg.history.length>0) dctx.putImageData(cfg.history[cfg.history.length-1],0,0);
        dctx.strokeStyle=cfg.color;
        dctx.lineWidth=cfg.size/2;
        dctx.beginPath();
        dctx.moveTo(bStartX,bStartY);
        dctx.lineTo(nx,ny);
        dctx.stroke();
    }
    else {
        dctx.lineCap='round';
        dctx.strokeStyle=cfg.color;
        dctx.beginPath();
        dctx.moveTo(lx,ly);
        dctx.lineTo(nx,ny);
        dctx.stroke();
    }

    lx=nx; ly=ny;
},{passive:false});

d.addEventListener('touchend',()=>{
    if(cfg.tool==='cut'||cfg.tool==='copy'){
        dctx.closePath();
        dctx.clip();
        cfg.clip=dctx.getImageData(0,0,d.width,d.height);
        cfg.pasting=true;
        cfg.anchorX=lx; cfg.anchorY=ly;
    }
    cfg.history.push(mctx.getImageData(0,0,m.width,m.height));
});

/**
 * VAULT & IMPORT
 */
async function vAction(mode){
    const db=await openDB();
    const tx=db.transaction('vault','readwrite');
    const store=tx.objectStore('vault');
    if(mode==='save'){
        const data=m.toDataURL('image/png');
        await store.put({id:Date.now(),data});
        alert('SAVED TO VAULT');
    }
    loadVault();
}

async function openDB(){
    return new Promise(res=>{
        const req=indexedDB.open('RetoucherVault',1);
        req.onupgradeneeded=()=>req.result.createObjectStore('vault',{keyPath:'id'});
        req.onsuccess=()=>res(req.result);
    });
}

async function loadVault(){
    const db=await openDB();
    const list=document.getElementById('vaultList');
    list.innerHTML='';
    const tx=db.transaction('vault','readonly');
    tx.objectStore('vault').openCursor().onsuccess=e=>{
        const cursor=e.target.result;
        if(cursor){
            const img=new Image();
            img.src=cursor.value.data;
            img.onclick=()=>{
                const i=new Image();
                i.src=img.src;
                i.onload=()=>mctx.drawImage(i,0,0);
            };
            list.appendChild(img);
            cursor.continue();
        }
    };
}

function undo(){ if(cfg.history.length>0) mctx.putImageData(cfg.history.pop(),0,0); }
function clr(){ mctx.fillStyle='#000'; mctx.fillRect(0,0,m.width,m.height); dctx.clearRect(0,0,d.width,d.height); }

function imp(){
    const input=document.createElement('input');
    input.type='file';
    input.onchange=e=>{
        const reader=new FileReader();
        reader.onload=b=>{
            const img=new Image();
            img.onload=()=>mctx.drawImage(img,0,0,m.width,m.height);
            img.src=b.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };
    input.click();
}

// Initialize vault thumbs
loadVault();
init();
</script>
/**
 * QUICK SAVE & CLIPBOARD
 */
function qSave(){
    const data=m.toDataURL('image/png');
    document.getElementById('q-thumb-dock').src=data;
    cfg.clip=mctx.getImageData(0,0,m.width,m.height);
    cfg.pasting=true;
}

/**
 * HANDLE PASTE
 */
function handlePaste(){
    if(!cfg.clip) return;
    cfg.pasting=true;
    dctx.clearRect(0,0,d.width,d.height);
    dctx.putImageData(cfg.clip,0,0);
}

/**
 * STICKER TOOL
 */
function handleSticker(){
    const url=prompt('Enter Sticker URL:');
    if(!url) return;
    const img=new Image();
    img.crossOrigin='anonymous';
    img.onload=()=>mctx.drawImage(img,m.width/4,m.height/4,img.width,img.height);
    img.src=url;
}

/**
 * VAULT THUMBS
 */
function loadVaultThumbs(){
    for(let i=0;i<2;i++){
        const thumb=document.getElementById(`v-thumb-${i}`);
        if(!thumb) continue;
        const tx=indexedDB.open("WaterfallPro_DB_Surgery",1);
        tx.onsuccess=function(e){
            const db=e.target.result;
            const t=db.transaction("slots","readonly").objectStore("slots");
            t.get(i).onsuccess=ev=>{
                if(ev.target.result) thumb.src=ev.target.result;
            };
        };
    }
}

/**
 * TOGGLE PANELS
 */
function toggleP(id){
    const panel=document.getElementById(id);
    const isOpen=panel.classList.contains('open');
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('open'));
    if(!isOpen) panel.classList.add('open');
}

/**
 * TOGGLE TOOLS
 */
function toggleT(tool){
    cfg.tool=cfg.tool===tool?null:tool;
    document.querySelectorAll('.t-btn').forEach(b=>{
        if(b.id===cfg.tool) b.classList.add('active');
        else b.classList.remove('active');
    });
}

/**
 * TOGGLE EDIT MODE
 */
function toggleEdit(){
    cfg.edit=!cfg.edit;
    document.getElementById('edit-box').classList.toggle('active',cfg.edit);
}

/**
 * FONT / STYLE SELECTION (for text tool)
 */
function selectFont(f){
    cfg.font=f;
    document.querySelectorAll('.style-item').forEach(el=>el.classList.remove('active'));
    document.querySelector(`.style-item[font="${f}"]`)?.classList.add('active');
}

/**
 * HELPER - SAVE HISTORY BEFORE ACTION
 */
function saveHistory(){
    if(cfg.history.length>20) cfg.history.shift();
    cfg.history.push(mctx.getImageData(0,0,m.width,m.height));
}

/**
 * INITIALIZATION CALLS
 */
window.addEventListener('load',()=>{
    init();
    loadVaultThumbs();
});
