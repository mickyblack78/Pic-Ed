<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #1a1a1a; font-family: sans-serif; overflow: auto; height: 5000px; width: 5000px; }
        canvas { position: absolute; top: 0; left: 0; background: white; touch-action: none; z-index: 1; }
        .panel { position: fixed; background: rgba(25,25,25,0.95); color: white; padding: 12px; border-radius: 12px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; border: 1px solid #0ff; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #paintPanel { top: 10px; left: 10px; width: 150px; }
        #menuPanel { top: 10px; right: 10px; width: 180px; }
        #actionPanel { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: row; }
        .box { width: 100%; height: 35px; border: 1px solid #444; border-radius: 4px; }
        .shade-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; }
        .shade-box { width: 25px; height: 25px; border: 1px solid #000; cursor: pointer; }
        .thumb-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; }
        .thumb { width: 2cm; height: 2cm; background: #333; position: relative; border: 1px solid #0ff; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .del { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; border: none; width: 18px; height: 18px; font-size: 10px; cursor: pointer; }
        label { font-size: 10px; color: #0ff; font-weight: bold; }
        input[type="range"] { width: 100%; }
        button { padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 6px; font-weight: bold; }
        button.active { background: #008888; border: 2px solid #0ff; box-shadow: 0 0 10px #0ff; }
    </style>
</head>
<body>

<canvas id="c" width="5000" height="5000"></canvas>

<div id="paintPanel" class="panel">
    <div id="paintBox" class="box" style="background: #000000;"></div>
    <label>RAINBOW</label>
    <input type="range" id="rainbow" min="0" max="360" value="0" oninput="syncFromSlider(this.value)">
    <div id="shades" class="shade-grid"></div>
    <label>SIZE</label>
    <input type="range" id="size" min="1" max="100" value="5" oninput="brushSize = this.value">
    <label>OPACITY</label>
    <input type="range" id="alpha" min="0" max="100" value="100" oninput="brushOpacity = this.value/100">
</div>

<div id="menuPanel" class="panel">
    <button onclick="saveToGallery()">SAVE</button>
    <button onclick="document.getElementById('fileIn').click()">IMPORT</button>
    <input type="file" id="fileIn" hidden onchange="importImg(event)">
    <button onclick="exportPNG()">EXPORT PNG</button>
    <div id="gallery" class="thumb-grid"></div>
</div>

<div id="actionPanel" class="panel">
    <button id="drawBtn" onclick="toggleTool('draw')">DRAW</button>
    <button id="pickBtn" onclick="toggleTool('pick')">PICKER</button>
</div>

<script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let drawing = false, currentTool = null, brushSize = 5, brushOpacity = 1, activeColor = '#000000', history = [];

    function toggleTool(tool) {
        const btn = document.getElementById(tool + 'Btn');
        if (currentTool === tool) {
            currentTool = null;
            btn.classList.remove('active');
        } else {
            document.querySelectorAll('#actionPanel button').forEach(b => b.classList.remove('active'));
            currentTool = tool;
            btn.classList.add('active');
        }
    }

    function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX + window.scrollX, y: clientY + window.scrollY };
    }

    canvas.addEventListener('pointerdown', (e) => {
        const pos = getCoords(e);
        if (currentTool === 'pick') {
            const d = ctx.getImageData(pos.x, pos.y, 1, 1).data;
            const hex = "#" + ((1 << 24) + (d[0] << 16) + (d[1] << 8) + d[2]).toString(16).slice(1);
            updateAllUI(hex);
        } else if (currentTool === 'draw') {
            drawing = true;
            ctx.beginPath();
            ctx.setLineDash([]);
            ctx.moveTo(pos.x, pos.y);
        }
    });

    canvas.addEventListener('pointermove', (e) => {
        if (!drawing || currentTool !== 'draw') return;
        const pos = getCoords(e);
        ctx.lineWidth = brushSize;
        ctx.globalAlpha = brushOpacity;
        ctx.strokeStyle = activeColor;
        ctx.lineCap = 'round';
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    });

    window.addEventListener('pointerup', () => {
        if (drawing) history.push(canvas.toDataURL());
        drawing = false;
    });

    function updateAllUI(hex) {
        activeColor = hex;
        document.getElementById('paintBox').style.backgroundColor = hex;
        // Simple RGB to HSL for slider sync
        let r=parseInt(hex.slice(1,3),16)/255, g=parseInt(hex.slice(3,5),16)/255, b=parseInt(hex.slice(5,7),16)/255;
        let max=Math.max(r,g,b), min=Math.min(r,g,b), h;
        if(max==min) h=0; else if(max==r) h=60*(g-b)/(max-min); else if(max==g) h=60*(b-r)/(max-min)+120; else h=60*(r-g)/(max-min)+240;
        document.getElementById('rainbow').value = h < 0 ? h + 360 : h;
        genShades(document.getElementById('rainbow').value);
    }

    function syncFromSlider(h) {
        const hex = `hsl(${h}, 100%, 50%)`;
        activeColor = hex;
        document.getElementById('paintBox').style.backgroundColor = hex;
        genShades(h);
    }

    function genShades(h) {
        const s = document.getElementById('shades'); s.innerHTML = '';
        for(let i=1; i<=10; i++) {
            const b = document.createElement('div'); b.className = 'shade-box';
            b.style.background = `hsl(${h}, 100%, ${i*9}%)`;
            b.onclick = () => { activeColor = b.style.background; document.getElementById('paintBox').style.backgroundColor = activeColor; };
            s.appendChild(b);
        }
    }

    function importImg(e) {
        const r = new FileReader();
        r.onload = (v) => {
            const img = new Image();
            img.onload = () => {
                const s = (window.innerWidth * 0.8) / img.width;
                const w = img.width * s, h = img.height * s;
                const x = window.scrollX + (window.innerWidth - w)/2;
                const y = window.scrollY + (window.innerHeight - h)/2;
                ctx.globalAlpha = 1; ctx.drawImage(img, x, y, w, h);
                history.push(canvas.toDataURL());
            };
            img.src = v.target.result;
        };
        r.readAsDataURL(e.target.files[0]);
    }

    function exportPNG() {
        const l = document.createElement('a'); l.download = 'art.png';
        l.href = canvas.toDataURL(); l.click();
    }

    function saveToGallery() {
        const gal = document.getElementById('gallery');
        const div = document.createElement('div'); div.className = 'thumb';
        const img = new Image(); img.src = canvas.toDataURL();
        const d = document.createElement('button'); d.className = 'del'; d.innerText = 'X';
        d.onclick = () => div.remove();
        div.append(img, d); gal.appendChild(div);
    }

    genShades(0);
</script>
</body>
</html>
