<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pic Ed Stability - V2</title>
    <style>
        body { margin: 0; background: #000; color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; font-family: sans-serif; }
        #vp { flex: 1; overflow: hidden; position: relative; background: #111; display: flex; justify-content: center; align-items: center; cursor: crosshair; }
        canvas { position: absolute; touch-action: none; image-rendering: pixelated; }
        
        /* üü¢ SYSTEM DASHBOARD */
        #status-bar { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 3000; pointer-events: none; }
        .light { width: 10px; height: 10px; border-radius: 50%; background: #333; border: 1px solid #555; }
        .light.on { background: #00ff64; box-shadow: 0 0 8px #00ff64; }

        .nav { height: 80px; background: #151515; display: flex; justify-content: space-around; align-items: center; padding-bottom: 20px; border-top: 1px solid #444; z-index: 2000; }
        .btn { width: 22%; height: 50px; border-radius: 10px; background: #222; border: 1px solid #555; color: white; font-size: 10px; font-weight: bold; display: flex; flex-direction: column; justify-content: center; align-items: center; text-transform: uppercase; transition: 0.2s; }
        
        /* Glow States */
        .glow-active { border-color: #00ff64 !important; color: #00ff64 !important; box-shadow: 0 0 15px #00ff64 !important; }

        .panel { position: absolute; bottom: 100px; width: 90%; left: 5%; background: rgba(15,15,15,0.98); border-radius: 15px; padding: 15px; display: none; z-index: 2100; border: 1px solid #444; }
        
        /* üé® DYNAMIC SHADE GRID */
        .shade-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
        .shade-btn { height: 35px; border-radius: 5px; border: 1px solid #444; }

        .slider-wrap { margin: 15px 0; }
        input[type="range"] { width: 100%; height: 30px; }

        .tool-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    </style>
</head>
<body>
    <div id="status-bar">
        <div id="l-power" class="light on"></div>
        <div id="l-sync" class="light"></div>
        <div id="l-secure" class="light"></div>
    </div>

    <div id="vp">
        <canvas id="baseCvs"></canvas>
        <canvas id="editCvs"></canvas>
    </div>

    <div id="menuPanel" class="panel">
        <div class="tool-grid">
            <button class="btn" onclick="Engine.io('up')">Upload</button>
            <button class="btn" onclick="Engine.io('dl')">Export</button>
            <button class="btn" onclick="Engine.copy()">Copy üìã</button>
            <button class="btn" onclick="Engine.rotate()">Rotate üîÑ</button>
            <button class="btn" onclick="Engine.resetView()">Center üéØ</button>
            <button class="btn" onclick="Engine.clear()" style="color:red">Burn üî•</button>
        </div>
    </div>

    <div id="brushPanel" class="panel">
        <div id="shadeContainer" class="shade-grid"></div>
        <input type="range" min="0" max="360" value="0" oninput="Engine.updateHue(this.value)">
        <p style="font-size: 10px; margin: 5px 0;">Size</p>
        <input type="range" id="bSize" min="2" max="100" value="20">
    </div>

    <nav class="nav">
        <button id="btn-menu" class="btn" onclick="Engine.toggleUI('menu')">Menu</button>
        <button id="btn-brush" class="btn" onclick="Engine.toggleUI('brush')">Brush</button>
        <button id="btn-edit" class="btn" onclick="Engine.toggleEdit()">Edit Off</button>
        <button class="btn" onclick="Engine.undo()">Undo ‚è≥</button>
    </nav>

    <script>
        const Engine = {
            base: document.getElementById('baseCvs'),
            edit: document.getElementById('editCvs'),
            btx: null, etx: null,
            mode: 'pan', scale: 1, ox: 0, oy: 0,
            curHue: 0, curCol: '#ff0000',
            history: [],

            init() {
                this.btx = this.base.getContext('2d');
                this.etx = this.edit.getContext('2d');
                this.updateHue(0);
                this.loadImg('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=800');
            },

            toggleUI(type) {
                const p = document.getElementById(type + 'Panel');
                const b = document.getElementById('btn-' + type);
                const isShowing = p.style.display === 'block';
                
                // Close all
                document.querySelectorAll('.panel').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.nav .btn').forEach(el => { if(el.id !== 'btn-edit') el.classList.remove('glow-active')});

                if (!isShowing) {
                    p.style.display = 'block';
                    b.classList.add('glow-active');
                }
            },

            toggleEdit() {
                const b = document.getElementById('btn-edit');
                this.mode = (this.mode === 'pan') ? 'draw' : 'pan';
                b.innerText = this.mode === 'pan' ? 'Edit Off' : 'Edit On';
                this.mode === 'pan' ? b.classList.remove('glow-active') : b.classList.add('glow-active');
            },

            updateHue(h) {
                this.curHue = h;
                const container = document.getElementById('shadeContainer');
                container.innerHTML = '';
                const brushBtn = document.getElementById('btn-brush');
                
                for(let i=0; i<10; i++) {
                    const lum = 10 + (i * 8);
                    const col = `hsl(${h}, 100%, ${lum}%)`;
                    const div = document.createElement('div');
                    div.className = 'shade-btn';
                    div.style.background = col;
                    div.onclick = () => {
                        this.curCol = col;
                        brushBtn.style.background = col;
                    };
                    container.appendChild(div);
                }
                this.curCol = `hsl(${h}, 100%, 50%)`;
                brushBtn.style.background = this.curCol;
            },

            rotate() {
                const t = document.createElement('canvas');
                t.width = this.base.height; t.height = this.base.width;
                const tx = t.getContext('2d');
                tx.translate(t.width/2, t.height/2); tx.rotate(Math.PI/2);
                tx.drawImage(this.base, -this.base.width/2, -this.base.height/2);
                this.base.width = this.edit.width = t.width;
                this.base.height = this.edit.height = t.height;
                this.btx.drawImage(t, 0, 0);
                this.resetView();
            },

            resetView() { this.scale = 0.5; this.ox = 0; this.oy = 0; this.update(); },
            update() { 
                const s = `translate(${this.ox}px, ${this.oy}px) scale(${this.scale})`;
                this.base.style.transform = this.edit.style.transform = s;
            },

            save() {
                if (this.history.length > 15) this.history.shift();
                this.history.push(this.etx.getImageData(0,0,this.edit.width,this.edit.height));
            },
            undo() { if(this.history.length) this.etx.putImageData(this.history.pop(), 0, 0); },

            io(type) {
                if(type === 'up') {
                    const i = document.createElement('input'); i.type='file';
                    i.onchange = e => {
                        const r = new FileReader();
                        r.onload = v => this.loadImg(v.target.result);
                        r.readAsDataURL(e.target.files[0]);
                    }; i.click();
                } else {
                    const a = document.createElement('a'); a.download = 'export.png';
                    const t = document.createElement('canvas'); t.width=this.base.width; t.height=this.base.height;
                    t.getContext('2d').drawImage(this.base,0,0); t.getContext('2d').drawImage(this.edit,0,0);
                    a.href = t.toDataURL(); a.click();
                }
            },

            loadImg(u) {
                const m = new Image(); m.crossOrigin = "anonymous";
                m.onload = () => {
                    this.base.width = this.edit.width = m.width;
                    this.base.height = this.edit.height = m.height;
                    this.btx.drawImage(m,0,0); this.resetView();
                }; m.src = u;
            },
            clear() { if(confirm('Burn edits?')) this.etx.clearRect(0,0,this.edit.width,
        
