<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waterfall Smudge QSAVE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; }
        #controls { position: absolute; bottom: 10px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 10; }
        .row { display: flex; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 8px; }
        button { padding: 10px; color: white; background: #444; border: 1px solid #666; border-radius: 4px; cursor: pointer; }
        button.active { background: #007bff; }
        input[type="range"] { width: 150px; }
        #canvas-container { position: relative; width: 100vw; height: 100vh; }
        canvas { position: absolute; top: 0; left: 0; touch-action: none; }
    </style>
</head>
<body>

<div id="canvas-container">
    <canvas id="bgCanvas"></canvas>
    <canvas id="drawCanvas"></canvas>
</div>

<div id="controls">
    <div class="row">
        <button onclick="switchSlot(1)" id="s1">Slot 1</button>
        <button onclick="switchSlot(2)" id="s2">Slot 2</button>
        <button onclick="switchSlot(3)" id="s3">Slot 3</button>
    </div>
    <div class="row">
        <button onclick="triggerImport()">Import</button>
        <button onclick="setMode('draw')" id="drawBtn" class="active">Draw</button>
        <button onclick="setMode('smudge')" id="smudgeBtn">Smudge</button>
        <button onclick="saveCurrentSlot()" style="background: #28a745;">QSAVE</button>
    </div>
    <div class="row">
        <input type="range" id="sizeBar" min="1" max="50" value="10">
    </div>
</div>

<input type="file" id="fileInput" hidden accept="image/*">

<script>
    const bgCanvas = document.getElementById('bgCanvas');
    const drawCanvas = document.getElementById('drawCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const drawCtx = drawCanvas.getContext('2d');
    const sizeBar = document.getElementById('sizeBar');
    const fileInput = document.getElementById('fileInput');

    let currentSlot = 1;
    let mode = 'draw';
    let isDrawing = false;
    let db;

    // --- DB SETUP (The Offline Filing Cabinet) ---
    const request = indexedDB.open("WaterfallApp", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("slots", { keyPath: "id" });
    };
    request.onsuccess = e => {
        db = e.target.result;
        switchSlot(1);
    };

    // --- CANVAS RESIZE ---
    function resize() {
        bgCanvas.width = drawCanvas.width = window.innerWidth;
        bgCanvas.height = drawCanvas.height = window.innerHeight;
    }
    window.onresize = resize;
    resize();

    // --- CORE LOGIC ---
    function setMode(m) {
        mode = m;
        document.getElementById('drawBtn').classList.toggle('active', m === 'draw');
        document.getElementById('smudgeBtn').classList.toggle('active', m === 'smudge');
    }

    function triggerImport() { fileInput.click(); }

    fileInput.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = event => {
            const img = new Image();
            img.onload = () => {
                bgCtx.clearRect(0,0,bgCanvas.width, bgCanvas.height);
                bgCtx.drawImage(img, 0, 0, bgCanvas.width, bgCanvas.height);
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    // --- DRAW & SMUDGE ENGINE ---
    function handleStart(e) { isDrawing = true; draw(e); }
    function handleEnd() { isDrawing = false; drawCtx.beginPath(); }

    function draw(e) {
        if (!isDrawing) return;
        const x = e.touches ? e.touches[0].clientX : e.clientX;
        const y = e.touches ? e.touches[0].clientY : e.clientY;
        const size = sizeBar.value;

        if (mode === 'draw') {
            drawCtx.lineWidth = size;
            drawCtx.lineCap = 'round';
            drawCtx.strokeStyle = 'white';
            drawCtx.lineTo(x, y);
            drawCtx.stroke();
            drawCtx.beginPath();
            drawCtx.moveTo(x, y);
        } else {
            // Smudge: Grabs pixels from background and blurs them onto drawing layer
            const imgData = bgCtx.getImageData(x - size/2, y - size/2, size, size);
            drawCtx.globalAlpha = 0.4;
            drawCtx.putImageData(imgData, x - size/2, y - size/2);
            drawCtx.globalAlpha = 1.0;
        }
    }

    drawCanvas.addEventListener('mousedown', handleStart);
    drawCanvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', handleEnd);
    drawCanvas.addEventListener('touchstart', handleStart);
    drawCanvas.addEventListener('touchmove', draw);
    window.addEventListener('touchend', handleEnd);

    // --- STORAGE ENGINE (QSAVE & LOAD) ---
    function saveCurrentSlot() {
        const data = {
            id: currentSlot,
            bg: bgCanvas.toDataURL('image/jpeg', 0.8), // Compressed for speed
            fg: drawCanvas.toDataURL('image/png')
        };
        db.transaction("slots", "readwrite").objectStore("slots").put(data);
        alert("QSAVE Slot " + currentSlot + " Success");
    }

    function switchSlot(id) {
        currentSlot = id;
        [1,2,3].forEach(n => document.getElementById('s'+n).classList.toggle('active', n === id));
        
        const tx = db.transaction("slots", "readonly");
        const store = tx.objectStore("slots");
        const req = store.get(id);
        
        req.onsuccess = () => {
            bgCtx.clearRect(0,0,bgCanvas.width, bgCanvas.height);
            drawCtx.clearRect(0,0,drawCanvas.width, drawCanvas.height);
            if (req.result) {
                const bgImg = new Image();
                bgImg.onload = () => bgCtx.drawImage(bgImg, 0, 0);
                bgImg.src = req.result.bg;

                const fgImg = new Image();
                fgImg.onload = () => drawCtx.drawImage(fgImg, 0, 0);
                fgImg.src = req.result.fg;
            }
        };
    }
</script>
</body>
</html>
