<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Drawing App</title>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #top-nav { position: fixed; top: 0; width: 100%; height: 60px; background: #222; display: flex; justify-content: space-around; align-items: center; z-index: 100; border-bottom: 1px solid #444; }
        .nav-btn { background: #333; border: 1px solid #555; color: white; padding: 10px; border-radius: 5px; cursor: pointer; min-width: 60px; text-align: center; transition: 0.2s; }
        .glow-active { box-shadow: 0 0 15px #00ff00 !important; border-color: #00ff00 !important; background: #444 !important; }
        #canvas-container { position: absolute; top: 60px; bottom: 0; width: 100%; display: flex; justify-content: center; align-items: center; background: #111; }
        canvas { background: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); touch-action: none; }
        .panel { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(34, 34, 34, 0.95); padding: 15px; border-radius: 10px; display: none; z-index: 200; width: 90%; max-width: 400px; border: 1px solid #444; }
        .tool-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .tool-btn { background: #444; border: 1px solid #666; color: white; padding: 8px 4px; border-radius: 5px; font-size: 11px; min-height: 35px; cursor: pointer; }
        #color-picker-container { display: none; margin-top: 10px; }
        input[type="color"] { width: 100%; height: 40px; border: none; border-radius: 5px; background: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="top-nav">
    <div id="btn-vault" class="nav-btn" onclick="toggleUI('vault-panel', 'btn-vault')">Gallery</div>
    <div id="btn-tools" class="nav-btn" onclick="toggleUI('tool-panel', 'btn-tools')">Action</div>
    <div id="btn-brush" class="nav-btn" onclick="toggleUI('brush-panel', 'btn-brush')">Paint</div>
    <div id="btn-edit-toggle" class="nav-btn" onclick="toggleEdit()">Edit</div>
</div>

<div id="canvas-container"><canvas id="mainCanvas"></canvas></div>

<div id="vault-panel" class="panel">
    <div class="tool-grid">
        <button class="tool-btn" onclick="document.getElementById('import-file').click()">Import</button>
        <button class="tool-btn" onclick="saveToDB()">Save DB</button>
        <button class="tool-btn" onclick="loadFromDB()">Load DB</button>
        <button class="tool-btn" style="color: #ff4444;" onclick="deleteFromDB()">Delete</button>
    </div>
    <input type="file" id="import-file" style="display:none" onchange="handleImport(event)">
</div>

<div id="tool-panel" class="panel">
    <div class="tool-grid">
        <button class="tool-btn" id="btn-draw" onclick="setMode('draw', 'btn-draw')">Draw</button>
        <button class="tool-btn" id="btn-erase" onclick="setMode('erase', 'btn-erase')">Erase</button>
        <button class="tool-btn" id="btn-select" onclick="setMode('select', 'btn-select')">Select</button>
        <button class="tool-btn" onclick="copySelection()">Copy</button>
        <button class="tool-btn" onclick="cutSelection()">Cut</button>
        <button class="tool-btn" onclick="pasteSelection()">Paste</button>
        <button class="tool-btn" onclick="undo()">Undo</button>
        <button class="tool-btn" onclick="clearCanvas()">Clear</button>
    </div>
</div>

<div id="brush-panel" class="panel">
    <button class="tool-btn" onclick="togglePicker()">Toggle Color Picker</button>
    <div id="color-picker-container">
        <input type="color" id="colorInput" value="#000000" oninput="brushColor = this.value">
    </div>
    <p>Size</p>
    <input type="range" id="bSize" min="1" max="100" value="10" oninput="brushSize = this.value" style="width:100%">
</div>

<script>
    const cvs = document.getElementById('mainCanvas'), ctx = cvs.getContext('2d');
    let drawing = false, currentMode = 'draw', isEditMode = false;
    let brushSize = 10, brushColor = '#000000', history = [], stickerImg = null;
    let startX, startY, selectionData = null, db;

    const request = indexedDB.open("DrawingAppDB", 1);
    request.onupgradeneeded = e => { db = e.target.result; db.createObjectStore("saves", { keyPath: "id" }); };
    request.onsuccess = e => db = e.target.result;

    function initCanvas() {
        const container = document.getElementById('canvas-container');
        cvs.width = container.clientWidth * 0.95;
        cvs.height = container.clientHeight * 0.9;
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, cvs.width, cvs.height);
        saveState();
    }

    function togglePicker() {
        const p = document.getElementById('color-picker-container');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    function setMode(mode, id) {
        currentMode = mode;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('glow-active'));
        if(id) document.getElementById(id).classList.add('glow-active');
    }

    function toggleUI(id, bid) {
        const p = document.getElementById(id);
        const open = p.style.display === 'block';
        document.querySelectorAll('.panel').forEach(x => x.style.display = 'none');
        document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('glow-active'));
        if(!open) { p.style.display = 'block'; document.getElementById(bid).classList.add('glow-active'); }
    }

    function toggleEdit() {
        isEditMode = !isEditMode;
        document.getElementById('btn-edit-toggle').classList.toggle('glow-active', isEditMode);
    }

    function saveState() {
        history.push(cvs.toDataURL());
        if(history.length > 20) history.shift();
    }

    function getXY(e) {
        const r = cvs.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
    }

    function start(e) {
        drawing = true;
        const p = getXY(e);
        startX = p.x; startY = p.y;
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
    }

    function move(e) {
        if(!drawing) return;
        const p = getXY(e);
        if(currentMode === 'select') {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0,0,cvs.width,cvs.height);
                ctx.drawImage(img,0,0);
                ctx.strokeStyle = '#00ff00';
                ctx.strokeRect(startX, startY, p.x-startX, p.y-startY);
            };
            img.src = history[history.length-1];
        } else {
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.strokeStyle = currentMode === 'erase' ? 'white' : brushColor;
            ctx.lineTo(p.x, p.y);
            ctx.stroke();
        }
    }

    function stop(e) {
        if(!drawing) return;
        drawing = false;
        if(currentMode === 'select') {
            const p = getXY(e);
            selectionData = { x: startX, y: startY, w: p.x-startX, h: p.y-startY };
        }
        saveState();
    }

    function undo() {
        if(history.length < 2) return;
        history.pop();
        const img = new Image();
        img.onload = () => { ctx.clearRect(0,0,cvs.width,cvs.height); ctx.drawImage(img,0,0); };
        img.src = history[history.length-1];
    }

    function clearCanvas() { ctx.fillStyle = 'white'; ctx.fillRect(0,0,cvs.width,cvs.height); saveState(); }

    function saveToDB() { db.transaction("saves", "readwrite").objectStore("saves").put({ id: "lastSave", data: cvs.toDataURL() }); }
    function loadFromDB() {
        db.transaction("saves").objectStore("saves").get("lastSave").onsuccess = e => {
            if(e.target.result) {
                const img = new Image();
                img.onload = () => { ctx.drawImage(img,0,0); saveState(); };
                img.src = e.target.result.data;
            }
        };
    }
    function deleteFromDB() { db.transaction("saves", "readwrite").objectStore("saves").delete("lastSave"); }

    cvs.addEventListener('mousedown', start); cvs.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
    cvs.addEventListener('touchstart', start); cvs.addEventListener('touchmove', move); cvs.addEventListener('touchend', stop);
    window.onload = initCanvas;
</script>
</body>
</html>
